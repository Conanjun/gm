<extend name="Public/base"/>
<block name="body">
    <script src="__JSNEW__/ckeditor/ckeditor.js"></script>
    <script src="__JSNEW__/all.fine-uploader/all.fine-uploader.min.js"></script>
    <link href="__JSNEW__/all.fine-uploader/fine-uploader-gallery.min.css" rel="stylesheet"/>
    <link href="__JSNEW__/all.fine-uploader/fine-uploader-new.min.css" rel="stylesheet"/>
    <link href="__CSS__/in/iviews-order.css" rel="stylesheet">
    <link href="__CSS__/in/stylesheet.css" rel="stylesheet">
    <script src="__JS__/in/vue.js"></script>
    <link href="__CSS__/in/piezas_dentales.css" rel="stylesheet">
    <style>
        .formbtn:hover{
            color:#333333
        }
        .qq-upload-button {
            width: 192px;
            height: 100px;
            border: 0;
            background: url("__ROOT__/admin/images/plus.png") no-repeat center center #efefef;
            border: 0;
            background-size: 50px;
        }
        .qq-upload-list-selector li{position: relative;}
        .pdel {
            background: url('__ROOT__/admin/images/cl.png') no-repeat left top;
            position: absolute;
            width: 14px;
            height: 14px;
            top: -5px;
            right:-5px;
            z-index: 1;
        }
        .qq-thumbnail-selector {
            vertical-align: middle;
            margin-right: 0px;
            width: 200px;
        }
        ul{
            list-style-type:none;
            margin: 0;
            padding: 0;
        }
        .sitem li.lion {
            background: #1ab394;
            color: #fff;
        }
        .sitem li{
            float: left;
            background: #f2f2f2;
            height: 25px;
            line-height: 25px;
            margin-right: 10px;
            padding: 0 10px;
            -webkit-border-radius: 2px;
            -moz-border-radius: 2px;
            border-radius: 2px;
            cursor: pointer;
            color: #888;
            transition: 0.3s;
        }
        .control-span{
            font-weight: normal;
            font-size: 16px;
            color: #999;
        }
        .col-sm-label{
            font-weight: normal;
            font-size: 16px;
            color: #999;
            float: left;
        }

    </style>
	
	<link href="__CSS__/n.css" rel="stylesheet"  type="text/css" />
	<link href="__CSS__/in/iviews-order.css" rel="stylesheet"  type="text/css" />

    <!-- content begin -->
    <div class="wrapper wrapper-content">

        <!-- in+ dom -->
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <!-- title -->
                    <div class="ibox-title">
                        <h5>
                            {:L('ORDER_MANAGE')}
                            <small>{:L('VIEW')}</small>
                        </h5>
                        <div class="ibox-button">
                            <if condition="($info['state'] eq 120 && $info['hasmaking'] eq 1) or ($info['state'] eq -1) or ($info['state'] eq 70 && $info['hasmaking'] eq 0 && $info['hasdesign'] eq 1)">
                                <a href="javascript:;" id="close" class="btn btn-primary btn-sm">{:L('CLOSE_ORDER')}</a>
                            </if>
                            <if condition="$info['state'] eq 110">
                                <a href="javascript:;" id="confirm_goods" class="btn btn-primary btn-sm">{:L('CONFIRM_GOODS')}</a>
                            </if>
                            <a href="javascript:history.go(-1);" class="btn btn-primary btn-sm" type="button">{:L('BACK')}</a>
                        </div>
                    </div>
                    <!-- content --><div class="row">
                    <div class="col-sm-12">
                    <div class="iviews-order">
                    <div class="iviews-order-content iviews-order-step7">

                                <div class="iviews-order-form">
                                    <form  class="form-horizontal">

                                        <div class="form-group">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('ORDER_STYPE')}</label>
                                            <div class="col-sm-1">
                                                <p class="form-control-static">{$info.dv2}</p>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>

                                        <div class="form-group">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('SERVICE_NAME')}</label>
                                            <div class="col-sm-4">
                                                <p class="form-control-static">{:L('PROSCH')}: <if condition="$info['hasdesign']">{:L('DESIGHOP')}</if><if condition="$info['hasmaking']">&nbsp;&nbsp;{:L('MODELMAKE')}</if></p>
                                            </div>
                                            <div class="col-sm-4">
                                                <p class="form-control-static">{:L('NORMALS')}: <if condition="$ns">{$ns|L}</if></p>
                                            </div>
                                            <label class="col-sm-2 col-sm-offset-1 control-label"></label>
                                            <div class="col-sm-4">
                                                <p class="form-control-static">{:L('OTHERS')}: <if condition="$os">{$os|L}</if></p>
                                            </div>
                                            <div class="col-sm-4">
                                                <p class="form-control-static">{:L('ORDER_UG')}: <if condition="$info['isurgent']">
                                                    {:L('YES')}
                                                    <else/>
                                                    {:L('NO')}
                                                </if></p>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>

                                        <div class="form-group">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('CUSTOMERINFO')}</label>
                                            <div class="col-sm-9">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <p class="form-control-static">{:L('DEINFO')}:  {$orderext.dername} {$orderext.deaddr}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <p class="form-control-static">{:L('SHIPINFO')}: {$orderext.shiprname} {$orderext.shipaddr}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('SHIPUNAME')}: {$orderext.shipuname}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('SHIPTEL')}: {$orderext.shiptel}</p>
                                                    </div>
                                                </div>
                                                <br>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('DOCINFO')}: {$orderext.doctor} {$orderext.doctor_tel}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('DOCOSSINFO')}: {$orderext.doctorass} {$orderext.doctorass_tel}</p>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('ADOCINFO')}: {$orderext.doctor1} {$orderext.doctor1_tel}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('ADOCOSSINFO')}: {$orderext.doctorass1} {$orderext.doctorass1_tel}</p>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>

                                        <div class="form-group">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('PAINFO')}</label>
                                            <div class="col-sm-9">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('MNAME')}: {$info.pname}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('SEX')}: <eq name="info.psex" value="1">{:L('MAN')}<else/><eq name="info.psex" value="2">{:L('WOMAN')}<else/>{:L('SECRECY')}</eq></eq></p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('P_BR')}: <if condition="$orderext['pebirth']">{$orderext['pebirth']|date="Y-m-d H:i",###}<else/>-</if></p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('AGE')}: {$orderext.peage}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <p class="form-control-static">{:L('PAZHUSHU')}:{$orderext1.pedesc}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                    	<p class="form-control-static">{:L('JWBS')}:{$orderext1.pehistory}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('REPAIRBODY')}: {$orderext1.xft}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('PERIOD')}: {$orderext1.yzy}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('TOOTHLOOSE')}: {$orderext1.sd}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('FIXTYPE')}: {$orderext1.rt}</p>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <p class="form-control-static">{:L('PLANOPTIME')}: <if condition="$orderext1['surgerytime']">{$orderext1['surgerytime']|date="Y-m-d H:i",###}<else/>-</if></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>

                                        <div class="form-group">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('YWBJ')}</label>
                                            <div class="col-sm-9">
                                                <div class="row iviews-yawei">
                                                    <div class="col-sm-4">
                                                        <img src="" alt="">
                                                        <volist name="t" id="node">
                                                        	<input class="auth_rules rules_all" disabled="disabled" <eq name="node.h" value="1"> checked="checked"</eq> type="checkbox">{$node.value}&nbsp;&nbsp;
                                                        </volist>
                                                        <span>{:L('QSYWBJ')}</span>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <img src="" alt="">
                                                         <volist name="t1" id="node">
                                                        	<input class="auth_rules rules_all" disabled="disabled" <eq name="node.h" value="1"> checked="checked"</eq> type="checkbox">{$node.value}&nbsp;&nbsp;
                                                        </volist>
                                                        <span>{:L('NZYWBJ')}</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-4">
                                                        <p class="form-control-static">{:L('ZZBRAND')}: {$orderext1.surgerysystem}</p>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <p class="form-control-static">{:L('OPTOOL')}: {$orderext1.surgerytool}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>


                                        <div class="form-group form-group-cbct" style="padding-left: 20px">
                                            <label class="col-sm-2 col-sm-offset-1 control-label border-l">{:L('BLZL')}</label>
                                            <div class="col-sm-9">
                                                <div class="row">
                                                    <label class="col-sm-label control-label">{:L('KNMX')}:</label>
                                                    <div class="col-sm-11">
                                                        <p class="form-control-static" >{$orderext1.knmx}</p>
                                                    </div>
                                                </div>
                                                <if condition="$orderext1.pic3">
                                                    <div class="row iviews-cbct knmx_pic" >
                                                        <label class="col-sm-label control-label"> {:L('KXZP')}:</label>
                                                        <div class="col-sm-3">
                                                            <img src="{$orderext1.pic3}" >
                                                        </div>
                                                    </div>
                                                </if>
                                                <div class="row iviews-cbct">
                                                    <label class="col-sm-label control-label" style="padding-top: 0;">CBCT:</label>
                                                    <div class="col-sm-8 form-group-cbct-item" v-for="(item,$index) in step6.folder" :index="$index">
                                                        <span class="folder-name" v-cloak>{{ $orderfile.id }}</span>
                                                        <span class="folder-length" v-cloak>{{ item.file.length }}个文件</span>
                                                        <span class="folder-size" v-cloak>{{ item.total | sizeFilter}}</span>
                                                        <span class="folder-see" v-cloak @click="step6FolderSee" :data-index="$index">[{:L('INFO')}]</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3" style="padding-left: 0">
                                                        <span class="control-span" >{:L('PAZHUSHU')}:</span>
                                                    </div>
                                                    <div class="col-sm-11" style="padding-left: 80px;">
                                                        {$orderext1.note}
                                                    </div>
                                                </div>
                                                <div class="row iviews-cbct">
                                                    <label class="col-sm-label control-label"> {:L('KNZP')}:</label>
                                                    <div class="col-sm-3">
                                                        <img srv="{$orderext1.pic1}" >
                                                    </div>
                                                    <label class="col-sm-label control-label"> {:L('MBZP')}:</label>
                                                    <div class="col-sm-3">
                                                        <img srv="{$orderext1.pic2}" >
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <label class="col-sm-1 control-label"> {:L('HGDY')}:</label>
                                                    <div class="col-sm-1">
                                                        <p class="form-control-static"><eq name="orderext1.print1" value="1">{:L('YES')}<else/>{:L('NO')}</eq></p>
                                                    </div>
                                                    <label class="col-sm-1 control-label"> {:L('MXDY')}:</label>
                                                    <div class="col-sm-1">
                                                        <p class="form-control-static"><eq name="orderext1.print2" value="1">{:L('YES')}<else/>{:L('NO')}</eq></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group">
                                            <label class="col-sm-11 col-sm-offset-1 control-label border-l">方案上传 <small>
                                                <a href="{:U('Order/file_download')}" target="_blank" >模板下载</a></small></label>
                                        </div>

                                        <div class="form-group form-group-cbct" id="drop-zone">
                                            <div class="col-sm-11 col-sm-offset-1">
                                                <div class="form-group-cbct-file">
                                                    上传文件夹
                                                    <input type="file" name="filesToUpload[]" id="filesToUpload" multiple="multiple" webkitdirectory="" directory="" />
                                                </div>
                                                <div class="row" id="drop-show">
                                                    <div class="col-sm-12 form-group-cbct-item" v-for="(item,$index) in step6.folder" :index="$index">
                                                        <span class="folder-name" v-cloak>{{ item.id }}</span>
                                                        <span class="folder-length" v-cloak>{{ item.file.length }}个文件</span>
                                                        <span class="folder-size" v-cloak>{{ item.total | sizeFilter }}</span>
                                                        <span class="folder-see" @click="step6FolderSee" :data-index="$index">[查看]</span>
                                                        <span class="folder-del" @click="step6FolderDel($index)">[删除]</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="hr-line-dashed"></div>

                                        <div class="wrapper wrapper-content">
                                            <div class="row">
                                                <div class="col-lg-12">
                                                    <div class="ibox float-e-margins">
                                                        <!-- title -->
                                                        <div class="ibox-title">
                                                            <h5>{:L('COST_INFORMATION')}</h5>
                                                        </div>
                                                        <div class="ibox-content">
                                                            <table
                                                                    class="table table-center"
                                                                    style="text-align: center">
                                                                <thead>

                                                                <tr>
                                                                    <th style="width: 100px;text-align: left; padding-left: 10px">{:L('FEE_NAME')}</th>
                                                                    <th style="width: 80px;text-align: left">{:L('PAYMENT_METHOD')}</th>
                                                                    <th style="width: 80px;text-align: left">{:L('PAYMENT_STATUS')}</th>
                                                                    <th style="width: 100px;text-align: left">{:L('AMOUNT_PAYABLE')}</th>
                                                                    <th style="width: 80px;text-align: left">{:L('AMOUNT_PAID')}</th>
                                                                    <th style="width: 80px;text-align: left">{:L('PAY_CURRENCY')}</th>
                                                                    <th style="width: 150px;text-align: left">{:L('ADD_TIME')}</th>
                                                                    <th style="width: 150px;text-align: left">{:L('LAST_PAYMENTTIME')}</th>
                                                                    <th style="text-align: left">{:L('REMARKS')}</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                <notempty name="order_pay"> <volist name="order_pay" id="vo">
                                                                    <tr>
                                                                        <td style="text-align: left;width: 100px;padding-left: 10px">{$vo.feename}</td>
                                                                        <td style="text-align: left">
                                                                            <if condition="$vo['paytype']==0">
                                                                                {:L('CASH_PAYMENT')}
                                                                                <else/>
                                                                                {:L('PAY_MONTHLY')}
                                                                            </if>
                                                                        </td>
                                                                        <td style="text-align: left">
                                                                            <if condition="$vo['state']==0">
                                                                                {:L('UNPAID')}
                                                                                <else/>
                                                                                {:L('ALREADY_PAID')}
                                                                            </if>
                                                                        </td>
                                                                        <td style="text-align: left">{$vo.money}/{$vo.money1}</td>
                                                                        <td style="text-align: left;">{$vo.pay_money}</td>
                                                                        <td style="text-align: left">{$vo.currency}</td>
                                                                        <td style="text-align: left">
                                                                            <if condition="$vo['addtime']">{$vo['addtime']|date="Y-m-d H:i:s",###}<else/>-</if>
                                                                        </td>
                                                                        <td style="text-align: left">
                                                                            <if condition="$vo['paytime']">{$vo['paytime']|date="Y-m-d H:i:s",###}<else/>-</if>
                                                                        </td>
                                                                        <td style="text-align: left">{$vo.note}</td>
                                                                    </tr>
                                                                </volist> <else />
                                                                    <td colspan="9" class="text-center table_nodata">{:L('NOCONCENT')}</td>
                                                                </notempty>
                                                                </tbody>
                                                            </table></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="wrapper wrapper-content">
                                            <div class="row">
                                                <div class="col-lg-12">
                                                    <div class="ibox float-e-margins">
                                                        <!-- title -->
                                                        <div class="ibox-title">
                                                            <h5>{:L('OPERATION_RECORD')}</h5>
                                                        </div>
                                                        <div class="ibox-content">
                                                            <table
                                                                    class="table table-center"
                                                                    style="text-align: center">
                                                                <thead>

                                                                <tr>
                                                                    <th style="width: 160px; text-align: left;padding-left: 10px">{:L('ORDER_STATUS')}</th>
                                                                    <th style="width: 80px">{:L('OPERATION_USER')}</th>
                                                                    <th style="width: 160px">{:L('OPERATION_TIME')}</th>
                                                                    <th style="text-align: left">{:L('OPERATION_NOTE')}</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                <notempty name="order_log"> <volist name="order_log" id="vo">
                                                                    <tr>
                                                                        <td style="width: 160px; text-align: left;padding-left: 10px">{$vo.str_state|L}</td>
                                                                        <td style="width: 80px">{$vo.nickname}</td>

                                                                        <td style="width: 160px">
                                                                            <if condition="$vo['addtime']">{$vo['addtime']|date="Y-m-d H:i",###}<else/>-</if>
                                                                        </td>
                                                                        <td style="text-align: left">{$vo.note}</td>
                                                                    </tr>
                                                                </volist> <else />
                                                                    <td colspan="4" class="text-center table_nodata">{:L('NOCONCENT')}</td>
                                                                </notempty>
                                                                </tbody>
                                                            </table></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </form>
                                </div>

                            </div></div></div></div>
                </div>
            </div>
        </div>

    </div>
    <!-- content end -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        {:L('sysnotice')}
                    </h4>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">{:L('close')}</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>

    <script>
        var error_box = $("#errorModal");
        $(function () {
            $("#confirm_goods").click(function () {
                    var id="{$info.order_id}";
                    var url = "{:U('Order/confirm_goods')}";
                    var param = $("#send_form").serialize();
                    $.ajax({
                        url: base.url + url ,
                        type: 'POST' ,
                        data: {'id':id},
                        dataType: 'json' ,
                        beforeSend: function() {
                        },
                        success: function(res) {
                            if( res.status == 1 ) {
                                window.location.href = res.url;
                            } else {
                                modal.text(error_box, res.info);
                                modal.open(error_box);
                            }
                        },
                        error: function(err) {
                        }
                    })
            });
            $("#close").click(function () {
                var id="{$info.order_id}";
                var url = "{:U('Order/close')}";
                $.ajax({
                    url: base.url + url ,
                    type: 'POST' ,
                    data: {'id':id},
                    dataType: 'json' ,
                    beforeSend: function() {
                    },
                    success: function(res) {
                        if( res.status == 1 ) {
                            window.location.href = res.url;
                        } else {
                            modal.text(error_box, res.info);
                            modal.open(error_box);
                        }
                    },
                    error: function(err) {
                    }
                })
            });

            function handleDragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            }
            var dropZone = document.getElementById('drop-zone');
            // var dropFile = document.getElementById('filesToUpload');
            dropZone.addEventListener('dragover', handleDragOver, false);

            function handleFileSelect(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                var files = [], folder = '',
                    items = evt.dataTransfer.items;

                if ( order.step6.folder.length == 1 ) {
                    // alert('CBCT只允许上传一个文件夹');
                    $.scojs_message('CBCT只允许上传一个文件夹', $.scojs_message.TYPE_ERROR);
                    return false;
                }

                function folderRead(entry,ordername) {
                    var folderObj = { name: entry.name, total: 0, id: ordername, file: [] }

                    entry.createReader().readEntries(function (entries) {
                        folderObj.length = entries.length;
                        // let total = 0;
                        for (var i = 0; i < entries.length; i++) {
                            var entrys = entries[i];

                            if (entrys.isFile) {
                                entrys.file(function (file) {

                                    order.step6.loadStatus = true;
                                    // total += file.size;
                                    var fileObj = { name: file.name, size: file.size, type: file.type, time: 'ss'}
                                    // order.step6.loadStatus = true;
                                    // 打开状态层
                                    var fd = new FormData();
                                    fd.append('mypic', file);
                                    var url = "{:U('Dentist/Order/uploadFile',array('code'=>$code,'sn'=>$sn))}";
                                    /* var path = files[x].webkitRelativePath.split('/');
                                     path.pop();
                                     var filename = path.toString().replace(/,/g,'/');*/

                                    $.ajax({
                                        url: url,
                                        method: 'post',
                                        contentType: false, // 注意这里应设为false
                                        processData: false,
                                        cache: false,
                                        async: true,
                                        data: fd,
                                        success: function(res) {
                                            if ( typeof res == 'string' ) {
                                                res = JSON.parse(res);
                                            }

                                            if (!res) return false;
                                            fileObj.time = res.msg.addtime;
                                            fileObj.size = res.msg.size;
                                            folderObj.total += res.msg.size;
                                            order.step6.flagStatus = true;
                                            folderObj.file.push(fileObj)
                                            // total +=res.size;
                                            if ( folderObj.length == folderObj.file.length ) {
                                                order.step6.flagStatus = false;
                                                // order.step6.loadStatus = false;
                                            }
                                            $.full.open();
                                        },
                                        error: function(error) {
                                            console.log(error);
                                        }
                                    })
                                    // folderObj.total =  format_bytes(total);
                                    // folderObj.total = total;
                                })
                            } else {
                                folder = entrys.name;
                            }
                        }

                    });
                    console.log(folderObj);
                    order.step6.folder.push(folderObj)
                }
                for (var i = 0; i < items.length; i++) {
                    var entry = items[i].webkitGetAsEntry();
                    if (!entry) {
                        return;
                    }
                    if (entry.isFile) {
                        alert("{:L('PFUPLOADFILE')}");
                    } else {
                        folderRead(entry, '{$sn}');
                    }
                }
            }
            dropZone.addEventListener('drop', handleFileSelect, false);


            $('#filesToUpload').on('change', function(ev, ordername){
                ordername = '{$sn}'

                var folderObj = { name: '', id: ordername, total: 0, file: [], length: ev.target.files.length }

                if ( ev.target.files.length >= 1 ) {

                    var files = ev.target.files;
                    var name = files[0].webkitRelativePath.split('/')[0];
                    var total = 0;

                    folderObj.name = name;

                    for ( x in files ) {
                        order.step6.loadStatus = true;

                        if ( files[x].size != 'undefined' && files[x].size >= 0 ) {
                            //total += files[x].size;
                            let fileObj = { name: files[x].name, size: files[x].size, type: files[x].type, time: '' }
                            // var fileObj = { name: files[x].name, size: files[x].size, type: files[x].type, time: 'ss' }
                            var fd = new FormData();
                            fd.append('mypic', files[x]);
                            // fd.append('filename', 'ocdf/sdafsd');
                            var url1 = "{:U('Dentist/Order/uploadFile',array('code'=>$code,'sn'=>$sn))}";
                            $.ajax({

                                url: url1,
                                method: 'post',
                                contentType: false, // 注意这里应设为false
                                processData: false,
                                cache: false,
                                async: true,
                                data: fd,
                                success: function (res) {
                                    // console.log(res);
                                    // console.log(res.size);
                                    if (typeof res == 'string') {
                                        res = JSON.parse(res);
                                    }
                                    console.log(typeof res);
                                    var data = res;
                                    if (!data || data == 'false') return false;
                                    console.log(data);
                                    console.log(data.msg.size);
                                    fileObj.time = data.msg.addtime;
                                    fileObj.size = data.msg.size;
                                    order.step6.flagStatus = true;
                                    folderObj.file.push(fileObj)
                                    folderObj.total += data.msg.size;
                                    if (folderObj.length == folderObj.file.length) {
                                        order.step6.flagStatus = false;
                                        // order.step6.loadStatus = false;
                                    }

                                    $('.iviews-order-mask').css({
                                        'width': $(window).width(),
                                        'height': $(window).height(),
                                        'left': -$('.navbar-default').width(),
                                        'top': -$('#page-wrapper > .border-bottom').eq(0).height()
                                    })
                                    $('body').addClass('hasMask');
                                    $('#page-wrapper > .border-bottom').eq(0).addClass('hasMask');
                                    $('#page-wrapper > .wrapper').eq(0).addClass('hasMask');
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            })
                            // folderObj.total = format_bytes(total);
                        }
                    }
                    order.step6.folder.push(folderObj)
                } else {
                    alert("{:L('MISC')}");
                }

            })
        });
    </script>
</block>
