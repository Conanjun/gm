<extend name="Public/base"/>
<block name="btnarea">

</block>
<block name="body">
    <script src='__JSNEW__/jquery.validate.js' type='text/javascript'></script>
    <script src="__JSNEW__/ckeditor/ckeditor.js"></script>
    <link href="__CSS__/n.css" rel="stylesheet"  type="text/css" />
    <script>
        $(function () {
            $('#oneself').click(function(){
                if ($('#oneself').attr('checked')) {
                    $("input[name='unit_id']").val(0);
                    $("input[name='unit']").val("本人");
                    $("#bank_span").attr('class','')
                    $("#account_span").attr('class','')
                }else{
                    $("input[name='unit_id']").val(1);
                    $("input[name='unit']").val("");
                    $("#bank_span").attr('class','required')
                    $("#account_span").attr('class','required')
                }
            });
            $("[name='pid']").change(function () {
                if ($(this).val() != "" && $(this).val() != null) {
                    $(this).next('div.chosen-container').children().removeClass("error");
                }
            });

            $("#ches").change(function () {
                var op = $("#ches").find("option:selected");
                var iden = $(this).val();
                if (iden != undefined && iden != '') {
                    var pname = op.attr("pname");
                    var customer = op.attr("customer");
                    var contacts = op.attr("contacts");
                    var telno = op.attr("telno");
                    var type = op.attr("type");
                    var ow = op.attr("ow");
                    var yjamount = op.attr("yjamount");
                    var service = op.attr("service");

                    if (pname != undefined && pname != '') {
                        $("[name='projectname']").val(pname);
                    }
                    if (customer != undefined && customer != '') {
                        $("[name='cid']").val(customer);
                        $("[name='cid']").trigger('chosen:updated');
                    }
                    if (contacts != undefined && contacts != '') {
                        $("[name='contacts']").val(contacts);
                    }
                    if (telno != undefined && telno != '') {
                        $("[name='telno']").val(telno);
                    }
                    if (type != undefined && type != '') {
                        $("[name='type']").val(type);
                        $("[name='type']").trigger('chosen:updated');
                    }
                    if (ow != undefined && ow != '') {
                        $("[name='ownner']").val(ow);
                    }
                    if (yjamount != undefined && yjamount != '') {
                        $("[name='pamount']").val(yjamount);
                    }
                    if (service != undefined && service != '') {
                        $("[name='coreservice1']").val(service);
                    }


                    $("[name='coreservice']").hide();
                    $("[name='coreservice1']").show();

                } else {
                    $("[name='coreservice']").show();
                    $("[name='coreservice1']").hide();
                }
            });

            $('form').validate({
                errorPlacement: function (error, element) {
//	        $(element).next('.field_notice').hide();
                    if ($(element).css("display") == 'none') {
                        $(element).next('div.chosen-container').children().addClass("error");
                    }
                },
                onkeyup: false,
                rules: {
                    pid: {
                        required: true
                    },
                    type: {
                        required: true
                    },
                    unit: {
                        required: true
                    },
                    /* bank: {
                         required: true
                     },
                     account: {
                         required: true
                     }*/
                },
                messages: {
                    pid: {
                        required: '请选择相关项目名称'
                    },
                    type: {
                        required: '请选择相关成本类型'
                    },
                    unit: {
                        required: "请选择收款人"
                    },
                    /* bank: {
                         required: "请输入开户银行"
                     },
                     account: {
                         required: "请输入收款账号"
                     }*/
                }
            });
        });

        function changechoose(name) {
            $.closeModal();
            $('#custom').val(name);
            $('#choose').text(name);
        }
    </script>
    <style>
        input.form-control {
            border-left: 1px solid #ccc;
        }
    </style>
        <div id="titlebar">
            <div class="heading">
                <span class="prefix"><i class="icon-user"></i> </span> <strong>
                <small
                        class="text-muted"><i class="icon-plus"></i></small>
                报销单申请</strong>
            </div>
        </div>
        <form action="{:U('add')}" method="post" class="form-condensed" enctype="multipart/form-data"
              >
            <input type="hidden" name="unit_id" value="0">
            <table align="center" class="table table-form mytable ntable" style="width: 1100px;border:0px;margin: 0">
                <tbody>
                <tr>
                    <th width="100px">项目名称<span class="required"></span></th>
                    <td width="600px" colspan="3">
                        <select name="pid" class="form-control searchSelect chosen">
                            <option value=""></option>
                            <volist name="project" id="vo">
                                <option value="{$vo.pid}">{$vo.name}</option>
                            </volist>
                        </select>
                    </td>
                    <td width="400px"></td>
                </tr>
                <tr>
                    <th>收款单位<span class="required"></span></th>
                    <td style="width: 250px">
                        <style>
                            input.form-control {
                                border-left: 1px solid #ccc;
                            }
                        </style>
                        <div class="input-group">
                            <input type="hidden" name="state" value="0">
                            <input type="text" name="unit" class="form-control" value="本人" style="float: left" autocomplete="off">
                            <span class="input-group-addon fix-border" style="border-right: 1px solid #ccc" title="收款人是自己" style="border-right:1px solid #ccc">
                                是否本人<input  type="checkbox" id="oneself" checked  style="margin-bottom: -5px"/>
                            </span>
                        </div>
                    </td>
                    <th  style="width: 100px">成本类型 <span class="required"></span></th>
                    <td style="width: 250px">
                        <select name="type" class="form-control searchSelect chosen required">
                            <option value=""></option>
                            <foreach name="type" item="vo" key="k">
                                <option value="{$k}">{$vo}</option>
                            </foreach>
                        </select>
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <th>收款账号<span id="account_span" class=""></span></th>
                    <td>
                        <input type="text" name="account" class="form-control"  autocomplete="off">
                    </td>
                    <th>开户银行</th>
                    <td>
                        <input type="text" name="bank" class="form-control" autocomplete="off">
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <th class="w-90px">附件</th>
                    <td colspan="3">
                        <input type="file" name="f">
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <th class="w-90px thtop">申请说明</th>
                    <td colspan="4">
                        <textarea id="description" name="description" style="width: 100%;height: 160px;" class="ckeditor"></textarea>
                    </td>
                </tr>
                <tr>
                    <th class="w-90px">费用明细</th>
                    <td colspan="4">
                        <style>
                            .fileBox {
                                margin-bottom: 10px;
                                width: 100%
                            }

                            table.fileBox td {
                                padding: 0 !important
                            }

                            .fileBox td .btn {
                                border-radius: 0;
                                border-left: none;
                                /*padding: 7px 10px;*/
                            }


                            .file-wrapper.form-control {
                                border-left: 0px
                            }

                            /*   input.form-control {
                                   border-left: 0px
                               }*/

                            .file-wrapper.form-control .fileControl {
                                width: 100% !important;

                            }

                            @-moz-document url-prefix() {
                                .file-wrapper.form-control .fileControl {
                                    margin-top: -3px;
                                }
                            }
                        </style>

                        <div id='fileform' class="pr">
                            <a href="javascript:;" class="btn-addrow" id="btn-addrow" ><i class="icon icon-plus"></i></a>
                            <script language='Javascript'>dangerFiles = "php,php3,php4,phtml,php5,jsp,py,rb,asp,aspx,ashx,asa,cer,cdx,aspl,shtm,shtml,html,htm";</script>
                            <for start="0" end="1" name="i">
                                <table class='fileBox'>
                                    <tr>
                                        <td style="width: 20%">
                                            <select name="feecode[]" id="feecode_{$i}"
                                                    class="form-control searchSelect">
                                                <option  data-keys="{$i}"  data-name="" value=''>请选择类型</option>
                                                <foreach name="costType" item="vo" key="k">
                                                    <option data-keys="{$i}" data-name="{$vo}" value="{$k}">{$vo}
                                                    </option>
                                                </foreach>
                                            </select>
                                            <input type="hidden" class="feetype_{$i}" name="feetype[]" value="">
                                        </td>
                                        <td style="width: 20%">
                                            <select name="feecate[]" id="feecate_{$i}"
                                                    class="form-control searchSelect">
                                                <option  data-keys="{$i}"  data-name="" value=''>请选择分类</option>
                                            </select>
                                            <input type="hidden" class="catetype_{$i}" name="catetype[]" value="">
                                        </td>
                                        <td ><input type='text' name='money[]' class='form-control'  placeholder='金额' tabindex='-1'/>
                                            <input type="hidden" name="eid" value="{$eid}">
                                        </td>
                                        <td ><input type='text' name='invoicenum[]'  class='form-control' placeholder='发票数' tabindex='-1'/></td>
                                        <td ><input type='text' name='note[]' class='form-control' placeholder='备注' tabindex='-1'/></td>
                                        <td name="add"></td>
                                        <td style="width: 30px"><a href='javascript:void(0);' style="margin: 0;padding: 5px 10px"  onclick='delFile(this)'
                                                              class='btn btn-block'><i class='icon-remove'></i></a></td>
                                    </tr>
                                </table>
                            </for>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th></th>
                    <td colspan="4">
                        <div class="rightdiv">
                            <a href="javascript:history.go(-1);" class="btn btn-back"><i class="icon-goback icon-level-up icon-large icon-rotate-270"></i> 返回</a>
                            <a href="javascript:;" class="btn btn-primary" onclick="baocun();" data-loading="稍候..."><i class="icon-save"></i> 保存</a>
                        </div>
                    </td>
                    <td></td>
                </tr>
                </tbody>
            </table>
        </form>
</block>

<block name="script">
    <script type="text/javascript">
        //导航高亮
        highlight_subnav("{:U('Expense/expense')}");

        function baocun() {
            var unit_id = $("input[name='unit_id']").val();
            if(unit_id ==1){
                var acc = $("input[name='account']").val();
                var bank = $("input[name='bank']").val();

                if(!acc){
                    $("input[name='account']").addClass("error");
                    return;
                }
                if(!bank){
                    $("input[name='bank']").addClass("error");
                    return;
                }
            }
            var t=true;
            $("[name='feecode[]']").each(function(){
                var costtype=$(this).val();

                if(costtype){
                    var money=$(this).closest('table').find("input[name='money[]']").val();
                    if(money<0 || money=="" ||money=='null'){
                       $(this).closest('table').find("input[name='money[]']").addClass('error');
                       t=false;
                    }

                }
            });
            if(t){
                $('form').attr('action', "{:U('expenseSave')}");
                $('form').submit()
            }

        }
        $(function () {
            $("#btn-addrow").click(function(){
                var obj= $(".fileBox").last().find("[name= 'add']");
                addFile(obj);
            });

        });

        function addFile(clickedButton) {

            var fileRow = "  <table class='fileBox' id='fileBox_lgw'>\n    <tr>\n  " +
                " <td style='width: 20%'>" +
                " <select name='feecode[]'id='feecode_lgw' class='form-control searchSelect chosen'>" +
                " <option  data-keys='lgw'  data-name='' value=''>请选择类型</option> <foreach name='costType' item='vo' key='k'>" +
                " <option data-keys='lgw' data-name='{$vo}' value='{$k}'>{$vo}</option> </foreach>  </select>" +
                "</select>     <input type='hidden' class='feetype_lgw' name='feetype[]' value=''> </td> " +
                "<td style='width: 20%'>" +
                "  <select name='feecate[]' id='feecate_lgw'  class='form-control searchSelect'>" +
                "  <option  data-keys='lgw'  data-name='' value=''>请选择分类</option>" +
                " </select>" +
                " <input type='hidden' class='catetype_lgw' name='catetype[]' value=''>  </td>" +
                " <td class=''><input type='text' name='money[]' class='form-control' placeholder='金额' tabindex='-1' \/> <input type='hidden' name='eid' value='{$eid}'> </td><\/td>\n  " +
                " <td class=''><input type='text' name='invoicenum[]' class='form-control' placeholder='发票数' tabindex='-1' \/><\/td>\n  " +
                "<td class=''><input type='text' name='note[]' class='form-control' placeholder='备注' tabindex='-1' /></td>  " +
                " <td  name='add'><\/td>\n  " +
                "    <td class='w-30px'><a href='javascript:void(0);' onclick='delFile(this)' style='margin: 0;padding: 5px 10px' class='btn btn-block'><i class='icon-remove'><\/i><\/a><\/td>\n  " +
                "  <\/tr>\n  <\/table>";
            fileRow = fileRow.replace(/lgw/g,$('.fileBox').size());

            /* Get files and labels name.*/
            filesName = $(clickedButton).closest('tr').find('input[type="file"]').attr('name');
            /*    labelsName = $(clickedButton).closest('tr').find('input[type="text"]').attr('name');*/

            /* Add file input control and set files and labels name in it.*/
            $fileBox = $(clickedButton).closest('.fileBox').after(fileRow).next('.fileBox');
            /*   $fileBox.find('input[type="text"]').attr('name', labelsName);*/


            updateID();
        }

        /**
         * Delete a file input control.
         *
         * @param  object $clickedButton
         * @access public
         * @return void
         */
        function delFile(clickedButton) {
            if ($('.fileBox').size() == 1) return;
            $(clickedButton).closest('.fileBox').remove();
            updateID();
        }

        function updateID() {
            i = 1;
            $('.fileID').each(function () {
                $(this).html(i++)
            });
        }

        $(function () {
            // 类型切换的时候带出分类 : LGW
            $("[id^='feecode_']").live('change',function () {
                var k = $(this).find('option:selected').data('keys');
                var typeid = $(this).val();
                if(!typeid)
                {
                    $("[id='feecate_" + k + "']").html('');
                    $("[class='catetype_" + k + "']").val('');
                    $("[class='feetype_" + k + "']").val('');
                    return false;
                }
                // 把类型的名称带入
                var feetype = $(this).find('option:selected').data('name');
                $("[class='feetype_"+k+"']").val(feetype);
                var url = "{:U('Expense/ajaxCostSub')}";
                var typeid = $(this).val();
                $("[id='feecate_" + k + "']").html('');
                $.get(url, {'typeid': typeid}, function (result) {
                    var html = '';
                    if (result) {
                        $.each(result, function (i, val) {
                            if(i== 0)
                            {
                                $("[class='catetype_"+k+"']").val(val.subtype);
                            }
                            html += "<option value='" + val.id + "'data-keys='"+k+"' data-name='" + val.subtype + "'>" + val.subtype + "</option>";
                        });
                    }
                    $("[id='feecate_" + k + "']").append(html);
                }, 'json');
            })
            $("[id^='feecate_']").live('change',function () {
                var k = $(this).find('option:selected').data('keys');
                var catetype = $(this).find('option:selected').data('name');
                $("[class='catetype_"+k+"']").val(catetype);
            })
        });

    </script>
</block>
