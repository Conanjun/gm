<extend name="Public/base"/>
<block name="navhead">
    <li data-id="account"><span id="myname" style="color: #000"><a href="{:U('ProjectView/view?id='.$p['pid'])}"><i
            class="icon-map-marker"></i> {$p.name}</a>&nbsp;<span style="font-weight: bold;"
						<if condition="$p['state']==4"> class="textr"</if>
						<if condition="$p['state']==2"> class="textg"</if>
						<if condition="$p['state']==0"> class="textc"</if>
						<if condition="$p['state']==-1"> class="textc"</if>
						>{$p.sname}</span>&nbsp;<i class="icon-caret-down"></i>&nbsp;</span>
    </li>

</block>

<block name="body">
    <link href="__CSS__/newtitle.css" rel="stylesheet" type="text/css"/>
    <link href="__CSS__/n.css" rel="stylesheet"  type="text/css" />
    <style>
        #buildList {
            padding: 0px;
            margin: 0px;
        }

        .form-condensed .btn {
            height: 30px;
        }

        #buildList td {
            padding: 0
        }

        #sonModule, #moduleBox > span > input, #moduleBox > table {
            max-width: 1000px;
        }

        #childrenForm .col-table + .col-table .form-control {
            /*border-left: transparent;*/
        }

        #childrenForm .chosen-single {
            border-right: 0px;
        }

        .wwww a {
            width: 330px !important
        }

        .wwww .popover {
            top: -10px !important;
            left: 325px !important;
            width: 130px;
        }

        #childrenForm .chosen-single {
            border-right: 0;
            border-left: 0;
            border-top: 0;
        }

        .form-condensed .input-group > .input-group-btn > .btn {
            padding: 5px 13px;
        }

        .form-condensed .btn {
            float: none;
        }

        .labours .form-control[readonly] {
            background-color: #ffffff;
        }
        .rightdiv{float: right}
        .rightdiv .btn {
	margin-left: 10px;
font-size: 12px;
		padding: 6px 20px;
		border-radius: 4px;
		
}
    </style>
    <script language="Javascript">browseType = "unclosed";</script>
    <script>
        $(function () {
            var type = $("select[name='type[]'] option:selected").each(function (k, vo) {
                $('#budget' + k).attr('readonly', true);
//            $(this).parent().parent().parent().parent().next().find("input[name='budget[]']").attr('readonly',true);
            });
        });
    </script>
    <div id="featurebar">
        <include file="Public:newtitle"/>
        <div class="btn-group actions" style="float: right">
            <a href="javascript:history.go(-1);" class="btn" title="返回"><i
                    class="icon-goback icon-level-up icon-large icon-rotate-270"></i> 返回</a>
        </div>
    </div>
    <!-- 数据列表 -->
    <script>setTreeBox();</script>
    <div id="projectTaskForm">
        <div class="fnavbox">
            <div>
                <include file="Public:newfourtitle"/>
            </div>
            <div class="actions">
                <div class="btn-group">
                    项目成本预算需要依据项目范围、任务结构分解、工期进度计划制定。主要包括人力成本和报销/用款成本，人力成本根据不同任务对应的角色单人成本和预估工时制定，由系统根据项目范围自动生成；报销/用款成本依据公司财务报销系统中的费用类别分别进行预算。
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <form id="childrenForm" class="form-condensed" method="post" action="{:U('budget',array('pid'=>$pid))}">
            <div style="width:1050px;" class="pr">
                <a href="javascript:;" class="btn-addrow" id="btn-addrow"><i class="icon icon-plus"></i></a>
                <h2 style="font-size: 14px;margin-top:0;color: #21841d">费用预算</h2>
                <table class="table table-form mytable" id="buildList" style="border-bottom:0;">
                    <thead>
                    <tr class="text-center">
                        <th width="330px">费用项目</th>
                        <th width="130px">单价</th>
                        <th width="130px">数量</th>
                        <th width="100px">预算金额</th>
                        <th width="120px">预算时间</th>
                        <th width="200px">预算说明</th>
                        <th width="40px">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="moduleBox" colspan="7">
                            <div id="sonModule">
                                <notempty name="budget">
                                    <volist name="budget" id="vo">
                                        <div class="row-table addedItem">
                                            <input type="hidden" name="pbid[]" value="{$vo['pbid']}">
                                            <div class="col-table" id="mtype{$i}" data-toggle="popover"
                                                 data-placement="top">
                                                <div class="input-group wwww"
                                                     style="width: 330px;border-left:0px;border-right: 0px">
                                                    <select name="outitem1[]" id="outitem{$i}" data-key="{$i}"
                                                            class="form-control searchSelect chosen"
                                                            data-toggle="popover"
                                                            data-placement="top">
                                                        <option value=""></option>
                                                        <foreach name="f" item="v">
                                                            <option value="{$v}"
                                                            <if condition="$vo['outitem'] == $v"> selected</if>
                                                            >{$v}</option>
                                                        </foreach>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-top:0;"
                                                           id="price{$i}"
                                                           data-key="{$i}" name="price[]" value="{$vo['price']}"
                                                           class="form-control" placeholder="单价" autocomplete="off"
                                                           data-toggle="popover" data-placement="top">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-left:0;border-right:0;border-top:0;"
                                                           id="quantity{$i}" data-key="{$i}" name="quantity[]"
                                                           value="{$vo['quantity']}"
                                                           class="form-control" placeholder="数量" autocomplete="off"
                                                           data-toggle="popover" data-placement="top">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 100px;text-align: right;border-top:0;"
                                                           id="budget{$i}" name="budget[]" value="{$vo['budget']}"
                                                           class="form-control" placeholder="预算金额" readonly
                                                           autocomplete="off" title="预算">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text" readonly
                                                           value="{$vo['addtime']|time_format}"
                                                           title="预算时间" class="form-control" placeholder="预算时间"
                                                           autocomplete="off"
                                                           style="width: 120px;border-left:0px;border-top:0;border-right:0; ">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="">
                                                    <input type="text"
                                                           style="width: 199px;border-left:0;border-top:0;"
                                                           id="explain{$i}" data-key="{$i}" name="explain[]"
                                                           value="{$vo['explain']}"
                                                           class="form-control" placeholder="预算说明" autocomplete="off"
                                                           title="预算说明">
                                                </div>
                                            </div>
                                            <div class="col-table" width="40px">
                                                <div class="input-group">
                                                <span class="input-group-btn">

                                                                        <a href="javascript:;"
                                                                           onclick="deletedata(this,{$pid},{$vo['pbid']})"
                                                                           class="btn btn-block" style="border-right:0;border-top: 0px; ">
                                                                                        <i class="icon icon-remove"></i>
                                                    </a> </span>
                      </div>
                                            </div>
                                        </div>
                                    </volist>
                                    <else/>
                                    <for start="0" end="1" name="i">
                                        <div class="row-table addedItem">
                                            <div class="col-table outitem123" id="newmtype_{$i}" data-toggle="popover"
                                                 data-placement="top">
                                                <div class="input-group wwww"
                                                     style="width: 330px;border-left:0px;border-right: 0px">
                                                    <select name="outitem1[]" id="newoutitem_{$i}" data-key="{$i}"
                                                            class="form-control searchSelect chosen">
                                                        <option value=""></option>
                                                        <foreach name="f" item="v">
                                                            <option value="{$v}">{$v}</option>
                                                        </foreach>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="border-left:0px;">
                                                    <input type="text" style="width: 130px;text-align: right;border-top:0;"
                                                           name="price[]"
                                                           class="form-control" placeholder="单价" id="newprice_{$i}"
                                                           data-key="{$i}" autocomplete="off" data-toggle="popover"
                                                           data-placement="top">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="border-left:0px">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-top:0;border-left:0;border-right:0"
                                                           name="quantity[]"
                                                           class="form-control" placeholder="数量" id="newquantity_{$i}"
                                                           data-key="{$i}" autocomplete="off" data-toggle="popover"
                                                           data-placement="top">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="border-left:0px">
                                                    <input type="text" style="width: 100px;text-align: center;border-top:0"
                                                           name="budget[]"
                                                           class="form-control" readonly placeholder="" id="newbudget_{$i}"
                                                           autocomplete="off" title="预算金额">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text" readonly
                                                           title="预算时间" class="form-control" placeholder=""
                                                           autocomplete="off"
                                                           style="width: 120px;border-left:0px;border-top:0;border-right:0;text-align: center; ">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="border-left:0px">
                                                    <input type="text"
                                                           style="width: 199px;border-left:0;border-top:0;"
                                                           data-key="{$i}"
                                                           name="explain[]"
                                                           class="form-control" placeholder="预算说明" autocomplete="off"
                                                           title="预算说明">
                                                </div>
                                            </div>
                                            <div class="col-table" width="40px">
                                                <div class="input-group">
                                                <span class="input-group-btn"><a
                                                        href="javascript:;" onclick="deleteItem(this)"

                                                        class="btn btn-block" style="    border-right: 0;;border-top: 0px;"><i class="icon icon-remove"></i>

                                                                        </a> </span>
                                                </div>
                                            </div>
                                        </div>
                                    </for>
                                </notempty>
                            </div>
                        </td>
                    </tr>
                  
                    </tbody>

                </table>
            </div>
            <div  style="width:1050px;">
                <notempty name="budget">
                    <div style="width:100%;margin-top:10px;">
                        <div style="font-size: 16px;width:587px;display:inline-block;padding-left:140px"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">{$cashTotal.budget|fomatprice}
            </span>
                    </div>
                </notempty>
                <h2 style="font-size: 14px;margin-top:40px;color: #21841d">工时预算</h2>
                <table class="table table-form mytable labours" id="buildList" style="border-bottom:0;width:848px;">
                    <thead>
                    <tr class="text-center">
                        <th width="331px">费用项目</th>
                        <th width="129px">预算工时</th>
                        <th width="130px">实际工时</th>
                        <th width="100px">预算金额</th>
                        <th width="120px">预算时间</th>
                        <th width="39px">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="moduleBox" colspan="6">
                            <div id="sonModule">
                                <notempty name="inbudget.list">
                                    <volist name="inbudget.list" id="vo">
                                        <div class="row-table addedItem" style="display: block">
                                            <div class="col-table">
                                                <div class="input-group wwww"
                                                     style="width: 330px;">
                                                    <input type="text"
                                                           style="width: 330px;border-left:0px;border-right: 0px;border-top: 0px"
                                                           readonly value="{$vo['outitem']}" class="form-control"
                                                           placeholder="费用项目" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-top:0;"
                                                           readonly value="{$vo['chours']}" class="form-control"
                                                           placeholder="预算工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-left:0;border-right:0;border-top:0;"
                                                           readonly value="{$vo['finishours']}" class="form-control"
                                                           placeholder="实际工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 100px;text-align: right;border-top:0;"
                                                           value="{$vo['cbudget']|fomatprice2}" class="form-control"
                                                           placeholder="预算金额" readonly autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text" readonly
                                                           value="{$vo['addtime']|time_format}"
                                                           title="预算时间" class="form-control" placeholder="预算时间"
                                                           autocomplete="off"
                                                           style="width: 120px;border-left:0px;border-top:0;">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                <span class="input-group-btn">
                                                    <a data-keys="1" href="javascript:;" style="border-right:0;;border-top: 0px;"
                                                       onclick="deletedata(this,{$pid},{$vo['pbid']})"
                                                       class="btn btn-block">
                                                        <i class="icon icon-remove"></i>
                                                    </a> </span>
                                                </div>
                                            </div>
                                        </div>
                                    </volist>
                                </notempty>

                            </div>
                        </td>
                    </tr>
                    <!--<tr>
                        <td colspan="3">

                        </td>
                        <td colspan="1" class="text-right">
                        </td>
                        <td colspan="4" class="text-right"></td>
                    </tr>-->
                    </tbody>
                </table>
                <notempty name="inbudget.list">
                    <div class="total_1" style="width:100%;margin-top:10px;">
                        <div style="font-size: 16px;width:350px;display:inline-block;padding-left:140px"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="inbudget.total.chours">{$inbudget.total.chours}h</notempty></span>
                        <div style="font-size: 16px;width:20px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="inbudget.total.finishours">{$inbudget.total.finishours}h</notempty></span>
                        <div style="font-size: 16px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">{$inbudget.total.cbudget|fomatprice2}
            </span>
                    </div>
                </notempty>
             <!--   <h2 style="font-size: 14px;margin-top:40px;color: #21841d">预算外人力成本</h2>
                <table class="table table-form mytable labours" id="buildList" style="border-bottom:0;width:848px;">
                    <thead>
                    <tr class="text-center">
                        <th width="331px">费用项目</th>
                        <th width="130px">预算工时</th>
                        <th width="130px">实际工时</th>
                        <th width="100px">预算金额</th>
                        <th width="120px">预算时间</th>
                        <th width="40px">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="moduleBox" colspan="6">
                            <div id="sonModule">
                                <notempty name="offbudget.list">
                                    <volist name="offbudget.list" id="vo">
                                        <div class="row-table addedItem" style="display: block">
                                            <div class="col-table">
                                                <div class="input-group wwww"
                                                     style="width: 330px;">
                                                    <input type="text"
                                                           style="width: 330px;border-left:0px;border-right: 0px;border-top: 0px"
                                                           readonly value="{$vo['outitem']}" class="form-control"
                                                           placeholder="费用项目" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" >
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-top:0;"
                                                           readonly value="{$vo['chours']}" class="form-control"
                                                           placeholder="预算工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-left:0;border-right:0;border-top:0;"
                                                           readonly value="{$vo['finishours']}" class="form-control"
                                                           placeholder="实际工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 100px;text-align: right;border-top:0;"
                                                           value="{$vo['cbudget']|fomatprice2}" class="form-control"
                                                           placeholder="预算金额" readonly autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text" readonly
                                                           value="{$vo['addtime']|time_format}"
                                                           title="预算时间" class="form-control" placeholder="预算时间"
                                                           autocomplete="off"
                                                           style="width: 120px;border-left:0px;border-top:0;">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                <span class="input-group-btn">
                                                    <a data-keys="2" href="javascript:;" style="border-right:0;"
                                                       onclick="deletedata(this,{$pid},{$vo['pbid']})"
                                                       class="btn btn-block">
                                                        <i class="icon icon-remove"></i>
                                                    </a> </span>
                                                </div>
                                            </div>
                                        </div>
                                    </volist>
                                </notempty>

                            </div>
                        </td>
                    </tr>
                    &lt;!&ndash;<tr>
                        <td colspan="3">

                        </td>
                        <td colspan="1" class="text-right">
                        </td>
                        <td colspan="4" class="text-right"></td>
                    </tr>&ndash;&gt;
                    </tbody>
                </table>
                <notempty name="offbudget.list">
                    <div class="total_2" style="width:100%;margin-top:10px;">
                        <div style="font-size: 16px;width:350px;display:inline-block;padding-left:140px"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="offbudget.total.chours">{$offbudget.total.chours}h</notempty></span>
                        <div style="font-size: 16px;width:20px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="offbudget.total.finishours">{$offbudget.total.finishours}h</notempty></span>
                        <div style="font-size: 16px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">{$offbudget.total.cbudget|fomatprice2}
            </span>
                    </div>
                </notempty>-->
            <!--    <h2 style="font-size: 14px;margin-top:40px;color: #21841d">变更人力成本</h2>
                <table class="table table-form mytable labours" id="buildList" style="border-bottom:0;width:848px;">
                    <thead>
                    <tr class="text-center">
                        <th width="330px">费用项目</th>
                        <th width="130px">预算工时</th>
                        <th width="130px">实际工时</th>
                        <th width="100px">预算金额</th>
                        <th width="199px">预算时间</th>
                        <th width="40px">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="moduleBox" colspan="6">
                            <div id="sonModule">
                                <notempty name="chbudget.list">
                                    <volist name="chbudget.list" id="vo">
                                        <div class="row-table addedItem" style="display: block">
                                            <div class="col-table">
                                                <div class="input-group wwww"
                                                     style="width: 330px;">
                                                    <input type="text"
                                                           style="width: 330px;border-left:0px;border-right: 0px;border-top: 0px"
                                                           readonly value="{$vo['outitem']}" class="form-control"
                                                           placeholder="费用项目" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group" style="">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-top:0;"
                                                           readonly value="{$vo['chours']}" class="form-control"
                                                           placeholder="预算工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 130px;text-align: right;border-left:0;border-right:0;border-top:0;"
                                                           readonly value="{$vo['finishours']}" class="form-control"
                                                           placeholder="实际工时" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text"
                                                           style="width: 100px;text-align: right;border-top:0;"
                                                           value="{$vo['cbudget']|fomatprice2}" class="form-control"
                                                           placeholder="预算金额" readonly autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                    <input type="text" readonly
                                                           value="{$vo['addtime']|time_format}"
                                                           title="预算时间" class="form-control" placeholder="预算时间"
                                                           autocomplete="off"
                                                           style="width: 120px;border-left:0px;border-top:0;">
                                                </div>
                                            </div>
                                            <div class="col-table">
                                                <div class="input-group">
                                                <span class="input-group-btn">
                                                    <a data-keys="3" href="javascript:;" style="border-right:0;"
                                                       onclick="deletedata(this,{$pid},{$vo['pbid']})"
                                                       class="btn btn-block">
                                                        <i class="icon icon-remove"></i>
                                                    </a> </span>
                                                </div>
                                            </div>
                                        </div>
                                    </volist>
                                </notempty>

                            </div>
                        </td>
                    </tr>
                    &lt;!&ndash;<tr>
                        <td colspan="3">

                        </td>
                        <td colspan="1" class="text-right">
                        </td>
                        <td colspan="4" class="text-right"></td>
                    </tr>&ndash;&gt;
                    </tbody>
                </table>
                <notempty name="chbudget.list">
                    <div class="total_3" style="width:100%;margin-top:10px;">
                        <div style="font-size: 16px;width:350px;display:inline-block;padding-left:140px"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="chbudget.total.chours">{$chbudget.total.chours}h</notempty></span>
                        <div style="font-size: 16px;width:20px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">
                    <notempty name="chbudget.total.finishours">{$chbudget.total.finishours}h</notempty></span>
                        <div style="font-size: 16px;display:inline-block;"></div>
                        <span style="font-size: 16px;color: #FF4500;width:100px;display:inline-block;text-align:right">{$chbudget.total.cbudget|fomatprice2}
            </span>
                    </div>
                </notempty>-->
                <div style="line-height: 27px;margin-right:10px;font-size:14px;font-weight:bold;">

                    <if condition="cando('ProjectNew/budget',array($p['uid'],$p['pmuid']))">
                    <div style="float: left;margin-top: 20px">
                        <span style="font-size: 14px;color: #21841d">总预算: </span><span style="font-size: 18px;color: #FF4500;">{$total|fomatprice}</span>
</div>
                    </if>
                    <div class="form-condensed rightdiv" style="margin-top:20px">
                        <button type="button" id="backBtn"  class="btn btn-default"  onclick="history.go(-1);"><i class="icon-goback icon-level-up icon-large icon-rotate-270"></i> 返回</button>
                        <if condition="cando('ProjectNew/budget',array($p['uid'],$p['pmuid']))">
                            <a href="javascript:;" class="btn btn-primary" onclick="save()" data-loading="稍候..."><i class="icon-save"></i> 保存</a>
                        </if>
                    </div>
                </div>
                <div style="clear:both"></div>
            </div>
        </form>

    </div>
    <script>config.onlybody = 'no';</script>
    <script language="Javascript">
        $(function(){
            $("#btn-addrow").click(function(){
                var obj=$("#sonModule").children().last();
                addItem(obj);
            });
        })
        $('#budgetTip').mouseover(function () {
            $('#budgetTip').popover({"html": true, trigger: "focus"});
            $('#budgetTip').popover('show');
        });
        $('#budgetTip').mouseleave(function () {
            $('#budgetTip').popover({"html": true, trigger: "focus"});
            $('#budgetTip').popover('hide');
        });
        $(function () {
            $("[id^='price']").each(function () {
                var k = $(this).data('key');
                var price = $(this).val();
                var quantity = $("[id='quantity" + k + "']").val();
                var budget = price * quantity;
                $("[id='budget" + k + "']").val(budget);
            });
        });
        $("[id^='price']").bind('input propertychange', function () {
            var k = $(this).data('key');
            var price = $(this).val();
            var quantity = $("[id='quantity" + k + "']").val();
            var budget;
            if (isNaN(price) || isNaN(quantity) || price < 0 || quantity < 0) {
                budget = '';
            } else {
                budget = price * quantity;
            }

            $("[id='budget" + k + "']").val(budget);
        });
        $("[id^='newprice_']").live('input propertychange', function () {
            var k = $(this).data('key');
            var price = $(this).val();
            var quantity = $("[id='newquantity_" + k + "']").val();
            var budget;
            if (isNaN(price) || isNaN(quantity) || price < 0 || quantity < 0) {
                budget = '';
            } else {
                budget = price * quantity;
            }
            $("[id='newbudget_" + k + "']").val(budget);
        });

        $("[id^='quantity']").bind('input propertychange', function () {
            var k = $(this).data('key');
            var quantity = $(this).val();
            var price = $("[id='price" + k + "']").val();
            var budget;
            if (isNaN(price) || isNaN(quantity) || price < 0 || quantity < 0) {
                budget = '';
            } else {
                budget = price * quantity;
            }
            $("[id='budget" + k + "']").val(budget);
        });
        $("[id^='newquantity_']").live('input propertychange', function () {
            var k = $(this).data('key');
            var quantity = $(this).val();
            var price = $("[id='newprice_" + k + "']").val();
            var budget;
            if (isNaN(price) || isNaN(quantity) || price < 0 || quantity < 0) {
                budget = '';
            } else {
                budget = price * quantity;
            }
            $("[id='newbudget_" + k + "']").val(budget);
        });

        $(".side-body li a").click(function () {
            $(this).attr('class').val('active');
        });
        function deleteItem(obj) {
            if ($(obj).closest('.row-table').siblings('.row-table.addedItem').find('i.icon-remove').size() <= 0) {
                $(obj).closest('.labours').remove();
                var k = $(obj).data('keys');
                $("[class=total_" + k + "]").remove();
                return;
            }
            $(obj).closest('.row-table').remove();
        }

        function deletedata(obj, pid, id) {
           // alert($(obj).closest('.row-table').siblings('.row-table.addedItem').find('i.icon-remove').size());return;
            if (confirm("确定要删除数据吗？")) {
                $.ajax({
                    type: 'get',
                    url: "index.php?s=/Admin/ProjectNew/budgetdelete&pid=" + pid + "&id=" + id,
                    error: function () {
                        alert('网络繁忙，请稍后再试');
                    },
                    success: function (response) {
                        if (response.done == true) {
                            if ($(obj).closest('.row-table').siblings('.row-table.addedItem').find('i.icon-remove').size() <= 0){
                                var a=$(obj).closest('.row-table').children().last();
                                addItem(a);
                            }
                            deleteItem(obj);
                        } else {
                            alert(response.msg);
                        }
                    }
                });
            }
        }
        function addItem(obj)
        {
            var fileRow =  $('.row-table').size();
            var $inputgroup = $(obj).closest('.row-table');
            $inputgroup.after($inputgroup.clone()).next('.row-table').find('input').val('');
            $inputgroup.next().find("div.chosen-container").remove();
            $inputgroup.next().find(".outitem123").attr('id','newmtype_'+fileRow);
            var $select = $inputgroup.next().find("[name^='outitem1']");
            var $price =  $inputgroup.next().find("[name^='price']");
            var $quantity =  $inputgroup.next().find("[name^='quantity']");
            var $budget =  $inputgroup.next().find("[name^='budget']");
            var $del = $inputgroup.next().find(".btn-block");
            $del.attr('onclick', 'deleteItem(this)');
            $select .attr('id','newoutitem_'+fileRow);
            $price.attr('id','newprice_'+fileRow);
            $quantity.attr('id','newquantity_'+fileRow);
            $budget.attr('id','newbudget_'+fileRow);
            $select .attr('data-key',fileRow);
            $price.attr('data-key',fileRow);
            $quantity.attr('data-key',fileRow);
            $inputgroup.next().find(".chosen").children('option').attr('selected',false);
            var defaultChosenOptions = {no_results_text: noResultsMatch, width:'320px', allow_single_deselect: true, disable_search_threshold: 1, placeholder_text_single: ' ', placeholder_text_multiple: ' ', search_contains: true};
            $inputgroup.next().find(".chosen").chosen(defaultChosenOptions).on('chosen:showing_dropdown', function()
            {
                var $this = $(this);
                var $chosen = $this.next('.chosen-container').removeClass('chosen-up');
                var $drop = $chosen.find('.chosen-drop');
                $chosen.toggleClass('chosen-up', $drop.height() + $drop.offset().top - $(document).scrollTop() > $(window).height());
            });
            $inputgroup.next().find("[name^='pbid']").remove();

           // $inputgroup.next().find("[name^='mtime']").datetimepicker({step:10,lang:'ch',timepicker:true,format:'Y/m/d H:i'});
        }

       /* function addItem(obj) {
            var fileRow = " <div class='row-table addedItem'>" +
                " <div class='col-table' id='type4{$i}' ><div class='input-group' style='width: 330px;border-left:0px;border-right: 0px;border-top: 0'>" +
                " <select name='outitem1[]' class='form-control searchSelect chosen' style='border-top:0px;border-right: 0px'><option value=''></option>" +
                " <foreach name='f' item='v'><option value='{$v}'>{$v}</option></foreach>" +
                "</select></div></div> " +
                "<div class='col-table'><div class='input-group' style='border-left:0px'>" +
                "<input type='text' style='width: 130px;text-align: right;border-top: 0;border-right: 0' name='price[]'class='form-control' placeholder='单价' id='newprice_lgw'  data-key='lgw' autocomplete='off' title='单价' >" +
                "</div></div>  " +
                "<div class='col-table'><div class='input-group' style='border-left:0px'>" +
                "<input type='text' style='width: 130px;text-align: right;border-top: 0;border-right: 0'  name='quantity[]' class='form-control' placeholder='数量' id='newquantity_lgw' data-key='lgw' autocomplete='off' title='数量' >" +
                "</div></div> " +
                "<div class='col-table'><div class='input-group' style='border-left:0px'>" +
                "<input type='text' style='width: 100px;text-align: center;border-top: 0px'  name='budget[]' class='form-control' readonly placeholder='' id='newbudget_lgw' autocomplete='off'  title='预算金额'>\n" +
                "</div></div> <div class='col-table'><div class='input-group'>" +
                "<input type='text'  readonly title='预算时间' class='form-control' placeholder='' autocomplete='off' style='width: 120px;border-left:0px;border-top:0;border-right:0;text-align: center; '>\n" +
                " </div></div> <div class='col-table'><div class='input-group' style='border-left:0px'>" +
                "<input type='text' style='width: 199px;border-top: 0;border-right: 0'  data-key='{$i}' name='explain[]' class='form-control' placeholder='预算说明'  autocomplete='off' title='预算说明' >\n" +
                "</div></div>  " +
                " <div class='col-table' width='190px'><div class='input-group'>" +
                "<span class='input-group-btn'><a href='javascript:;' onclick='addItem(this)' style='border-left:0px'  class='btn btn-block'><i class='icon icon-plus'></i>\n" +
                " </a> </span>" +
                "<span class='input-group-btn'><a href='javascript:;' onclick='deleteItem(this)' class='btn btn-block'><i class='icon icon-remove'></i>" +
                " </a> </span></div></div>";
            fileRow = fileRow.replace(/lgw/g, $('.row-table').size());
            $("#sonModule").append(fileRow);
        }
*/
        function save() {
            var n = true;
            $("[id^='newquantity_']").each(function () {
                var k = $(this).data('key');
                var outitemLabel = $("[id='newoutitem_" + k + "']");
                var mtype = $("[id='newmtype_" + k + "']");
                var priceLabel = $("[id='newprice_" + k + "']");
                // 费用项目
                var outitem = outitemLabel.val();
                // 单价
                var price = priceLabel.val();
                // 数量验证
                var newquantity = $(this).val();
                if (outitem == '' && price == '' && newquantity == '') {
                    n = true;
                    return true;
                }
                if (outitem == "" || outitem == undefined || outitem == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>费用项目不可为空</p>";
                    mtype.attr('data-content', tip);
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('show');
                    mtype.focus();
                    return false;
                } else {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                }
                if (price == "" || price == undefined || price == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>单价不可为空</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (isNaN(price) || price <= 0) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>单价必须是大于0的数字</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (newquantity == "" || newquantity == undefined || newquantity == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>数量不可为空</p>";
                    $(this).attr('data-content', tip);
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('show');
                    $(this).focus();
                    return false;
                } else {
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('destroy');
                }
                if (isNaN(newquantity) || newquantity <= 0) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>数量必须是大于0的数字</p>";
                    $(this).attr('data-content', tip);
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('show');
                    $(this).focus();
                    return false;
                } else {
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('destroy');
                }
            });
            $("[id^='quantity']").each(function () {
                var k = $(this).data('key');
                var outitemLabel = $("[id='outitem" + k + "']");
                var mtype = $("[id='mtype" + k + "']");
                var priceLabel = $("[id='price" + k + "']");
                // 费用项目
                var outitem = outitemLabel.val();
                // 单价
                var price = priceLabel.val();
                // 数量验证
                var newquantity = $(this).val();
                if (outitem == "" || outitem == undefined || outitem == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>费用项目不可为空</p>";
                    mtype.attr('data-content', tip);
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('show');
                    mtype.focus();
                    return false;
                } else {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                }
                if (price == "" || price == undefined || price == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>单价不可为空</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (isNaN(price) || price <= 0) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>单价必须是大于0的数字</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (newquantity == "" || newquantity == undefined || newquantity == null) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>数量不可为空</p>";
                    $(this).attr('data-content', tip);
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('show');
                    $(this).focus();
                    return false;
                } else {
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('destroy');
                }
                if (isNaN(newquantity) || newquantity <= 0) {
                    n = false;
                    var tip = "<p style='color:#ff0000'>数量必须是大于0的数字</p>";
                    $(this).attr('data-content', tip);
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('show');
                    $(this).focus();
                    return false;
                } else {
                    $(this).popover({"html": true, trigger: "focus"});
                    $(this).popover('destroy');
                }
            });
            if (n) {
                $('form').submit();
            }

        }

        function updateItemOrder() {
            var order = 10;
            $('#sonModule').children('.row-table').each(function () {
                if ($(this).find("input[name*='order']").length > 0) {
                    console.log(order);
                    $(this).find("input[name*='order']").val(order);
                    order += 10;
                }
            });

            $('#maxOrder').val(order - 10);
        }

        function syncModule(rootID, type) {
            moduleID = type == 'task' ? $('#projectModule').val() : $('#productModule').val();
            type = type == 'task' ? 'task' : 'story';

            link = createLink('tree', 'ajaxGetSonModules', 'moduleID=' + moduleID + '&rootID=' + rootID + '&type=' + type);
            $.getJSON(link, function (modules) {
                if (modules.length == 0) return false;
                $('.helplink').addClass('hidden');
                var $inputgroup = $('<div></div>').append($('.input-group .icon-remove:first').closest('.row-table').clone()).html();
                $.each(modules, function (key, module) {
                    $('.row-table').each(function () {
                        moduleName = $(this).find('input[id^=modules]').val();
                        if (moduleName == module.name) modules[key] = null;
                        if (!moduleName) $(this).closest('.row-table').remove();
                    })
                });

                $.each(modules, function (key, module) {
                    if (module) {
                        $('#sonModule').append($inputgroup);
                        $('#sonModule .row-table:last input[id^=modules]').val(module.name);
                        $('#sonModule .row-table:last input[id^=shorts]').val(module.short);
                    }
                })
                $('#sonModule').append($inputgroup);
            })
        }

        function syncProductOrProject(obj, type) {
            if (type == 'product') viewType = 'story';
            if (type == 'project') viewType = 'task';
            link = createLink('tree', 'ajaxGetOptionMenu', 'rootID=' + obj.value + "&viewType=" + viewType + "&branch=0&rootModuleID=0&returnType=json");
            $.getJSON(link, function (modules) {
                $('.helplink').addClass('hidden');
                $('#' + type + 'Module').empty();
                $.each(modules, function (key, value) {
                    $('#' + type + 'Module').append('<option value=' + key + '>' + value + '</option')
                });
                $('#' + type + 'Module').trigger("chosen:updated");
            })
            $('#copyModule').attr('onclick', null);
            $('#copyModule').bind('click', function () {
                syncModule(obj.value, viewType)
            });
        }

        function toggleCopy() {
            var $copy = $('table.copy');
            if ($copy.size() == 0) return false;
            $copy.toggle();
        }

        $(document).ready(function () {
            toggleCopy();
            $('[data-id="create"] a').modalTrigger({type: 'iframe', width: 500});
            $('[data-id="edit"] a').modalTrigger({type: 'iframe', width: 500});

            $("[id^='outitem']").change(function () {
                var k = $(this).data('key');
                var outitem = $(this).val();
                var mtype = $("[id='mtype" + k + "']");
                if (outitem == "" || outitem == undefined || outitem == null) {
                    var tip = "<p style='color:#ff0000'>费用项目不可为空</p>";
                    mtype.attr('data-content', tip);
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('show');
                    mtype.focus();
                    return false;
                } else {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                }

            });
            $("[id^='price']").change(function () {
                var price = $(this).val();
                var k = $(this).data('key');
                var priceLabel = $("[id='price" + k + "']");
                if (price == "" || price == undefined || price == null) {
                    var tip = "<p style='color:#ff0000'>单价不可为空</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (isNaN(price) || price <= 0) {
                    var tip = "<p style='color:#ff0000'>单价必须是大于0的数字</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
            });
            $("[id^='newprice_']").change(function () {
                var price = $(this).val();
                var k = $(this).data('key');
                // 费用项目
                var outitem = $("[id='newoutitem_" + k + "']").val();
                // 单价
                var quantity = $("[id='newquantity_" + k + "']").val();
                var mtype = $("[id='newmtype_" + k + "']");

                if (outitem == '' && price == '' && quantity == '') {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                    return true;
                }

                var priceLabel = $("[id='newprice_" + k + "']");
                if (price == "" || price == undefined || price == null) {
                    var tip = "<p style='color:#ff0000'>单价不可为空</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
                if (isNaN(price) || price <= 0) {
                    var tip = "<p style='color:#ff0000'>单价必须是大于0的数字</p>";
                    priceLabel.attr('data-content', tip);
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('show');
                    priceLabel.focus();
                    return false;
                } else {
                    priceLabel.popover({"html": true, trigger: "focus"});
                    priceLabel.popover('destroy');
                }
            });
            $("[id^='quantity']").change(function () {
                var quantity = $(this).val();
                var k = $(this).data('key');
                var quantityLabel = $("[id='quantity" + k + "']");
                if (quantity == "" || quantity == undefined || quantity == null) {
                    var tip = "<p style='color:#ff0000'>数量不可为空</p>";
                    quantityLabel.attr('data-content', tip);
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('show');
                    quantityLabel.focus();
                    return false;
                } else {
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('destroy');
                }
                if (isNaN(quantity) || quantity <= 0) {
                    var tip = "<p style='color:#ff0000'>数量必须是大于0的数字</p>";
                    quantityLabel.attr('data-content', tip);
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('show');
                    quantityLabel.focus();
                    return false;
                } else {
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('destroy');
                }
            });
            $("[id^='newquantity_']").change(function () {
                var quantity = $(this).val();
                var k = $(this).data('key');
                // 费用项目
                var outitem = $("[id='newoutitem_" + k + "']").val();
                // 单价
                var price = $("[id='newprice_" + k + "']").val();
                var mtype = $("[id='newmtype_" + k + "']");

                if (outitem == '' && price == '' && quantity == '') {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                    return true;
                }
                var quantityLabel = $("[id='newquantity_" + k + "']");
                if (quantity == "" || quantity == undefined || quantity == null) {
                    var tip = "<p style='color:#ff0000'>数量不可为空</p>";
                    quantityLabel.attr('data-content', tip);
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('show');
                    quantityLabel.focus();
                    return false;
                } else {
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('destroy');
                }
                if (isNaN(quantity) || quantity <= 0) {
                    var tip = "<p style='color:#ff0000'>数量必须是大于0的数字</p>";
                    quantityLabel.attr('data-content', tip);
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('show');
                    quantityLabel.focus();
                    return false;
                } else {
                    quantityLabel.popover({"html": true, trigger: "focus"});
                    quantityLabel.popover('destroy');
                }
            });

            $("[id^='outitem']").change(function () {
                var k = $(this).data('key');
                var outitem = $(this).val();
                var mtype = $("[id='mtype" + k + "']");
                if (outitem == "" || outitem == undefined || outitem == null) {
                    var tip = "<p style='color:#ff0000'>费用项目不可为空</p>";
                    mtype.attr('data-content', tip);
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('show');
                    mtype.focus();
                    return false;
                } else {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                }
            });
            $("[id^='newoutitem_']").change(function () {
                var k = $(this).data('key');
                // 费用项目
                var outitem = $(this).val();
                // 单价
                var price = $("[id='newprice_" + k + "']").val();
                // 数量验证
                var quantity = $("[id='newquantity_" + k + "']").val();
                var mtype = $("[id='newmtype_" + k + "']");
                if (outitem == '' && price == '' && quantity == '') {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                    return true;
                }

                if (outitem == "" || outitem == undefined || outitem == null) {
                    var tip = "<p style='color:#ff0000'>费用项目不可为空</p>";
                    mtype.attr('data-content', tip);
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('show');
                    mtype.focus();
                    return false;
                } else {
                    mtype.popover({"html": true, trigger: "focus"});
                    mtype.popover('destroy');
                }
            });

        });

    </script>
</block>
<block name="script">
    <script type="text/javascript">
        //导航高亮
        highlight_subnav("{$from_url}");
    </script>
</block>
