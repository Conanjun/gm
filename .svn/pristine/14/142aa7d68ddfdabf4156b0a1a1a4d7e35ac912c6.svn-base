<extend name="Public/base"/>
<block name="body">

    <script src="__JSNEW__/ckeditor/ckeditor.js"></script>
    <script src='__JSNEW__/jquery.validate.min.js' type='text/javascript'></script>
    <link href="__CSS__/in/iviews-order.css" rel="stylesheet">
    <link href="__CSS__/in/stylesheet.css" rel="stylesheet">
    <script src="__JS__/in/vue.js"></script>
    <link href="__CSS__/in/piezas_dentales.css" rel="stylesheet">


    <style>
        .formbtn:hover{
            color:#333333
        }
        .qq-upload-button {
            width: 192px;
            height: 100px;
            border: 0;
            background: url("__ROOT__/admin/images/plus.png") no-repeat center center #efefef;
            border: 0;
            background-size: 50px;
        }
        .qq-upload-list-selector li{position: relative;}
        .pdel {
            background: url('__ROOT__/admin/images/cl.png') no-repeat left top;
            position: absolute;
            width: 14px;
            height: 14px;
            top: -5px;
            right:-5px;
            z-index: 1;
        }
        .qq-thumbnail-selector {
            vertical-align: middle;
            margin-right: 0px;
            width: 200px;
        }
        ul{
            list-style-type:none;
            margin: 0;
            padding: 0;
        }
        .sitem li.lion {
            background: #1ab394;
            color: #fff;
        }
        .sitem li{
            float: left;
            background: #f2f2f2;
            height: 25px;
            line-height: 25px;
            margin-right: 10px;
            padding: 0 10px;
            -webkit-border-radius: 2px;
            -moz-border-radius: 2px;
            border-radius: 2px;
            cursor: pointer;
            color: #888;
            transition: 0.3s;
        }
        [v-cloak] {
            display: none !important;
        }
    </style>

    <script src='__JSNEW__/jquery.datetimepicker.full.js' type='text/javascript'></script>
    <link href="__CSS__/jquery.datetimepicker.css" rel="stylesheet" type="text/css"/>
    <script>
        $(function(){
            $('#start_addtime').datetimepicker({
                value:'',
                lang:'ch',
                timepicker:false,format:'Y/m/d'
            });
            $('#end_addtime').datetimepicker({
                value:'',
                lang:'ch',
                timepicker:false,format:'Y/m/d'
            });
            $('#start_finishtime').datetimepicker({
                value:'',
                lang:'ch',
                timepicker:false,format:'Y/m/d'
            });
            $('#end_finishtime').datetimepicker({
                value:'',
                lang:'ch',
                timepicker:false,format:'Y/m/d'
            });
        });
    </script>

    <!-- content begin -->
    <div class="wrapper wrapper-content" id="app">

        <div class="row">
            <div class="col-lg-12">
                <!-- ibox begin -->
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>{:L('STUDIO_TASK_SJS')}</h5>
                    </div>

                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-lg-12">
                                <form method="get" class="form-horizontal">
                                    <input type="hidden" name="s" value="/Studio/OrderTaskSjs/index"/>
                                    <table id="tt_1">
                                        <tbody>
                                        <tr>
                                            <td>
                                                <label>{:L('TASK_LIST_NAME')}</label>
                                                <input class="form-control" type="text" name="tname" value="{$Think.get.tname}">
                                            </td>
                                            <td>
                                                <label>{:L('ORDER_SN')}</label>
                                                <input class="form-control" type="text" name="order_sn" value="{$Think.get.order_sn}">
                                            </td>
                                              <td>
                                                <label>{:L('ISURGENT')}</label>
                                                <select name="isurgent" class="form-control" style="width: 180px">
                                                    <option value="">{:L(PLEASE_SELECT)}</option>
                                                    <option value="1" <if condition="$Think.get.isurgent eq 1">selected</if>>{:L('YES')}</option>
                                                    <option value="2" <if condition="$Think.get.isurgent eq 2">selected</if>>{:L('NO')} </option>
                                                </select>
                                            </td>

                                        </tr>
                                        <tr>
                                            <td>
                                                <label>{:L('TASK_STATE')}</label>
                                                <select name="state" class="form-control" style="width: 180px">
                                                    <option value="">{:L(PLEASE_SELECT)}</option>
                                                    <option value="1" <if condition="$Think.get.state eq 1">selected</if>>{:L('FINISH')}</option>
                                                    <option value="2" <if condition="$Think.get.state eq 2">selected</if>>{:L('NOFINISH')} </option>
                                                </select>
                                            </td>
                                            <td>
                                                <label>{:L('TASK_SEND_TIME')}</label>
                                                <input style="width: 110px;" class="form-control" type="text"  id="start_addtime" name="start_addtime" value="{$Think.get.start_addtime}">
                                                <input style="width: 110px;" class="form-control" type="text" id="end_addtime" name="end_addtime" value="{$Think.get.end_addtime}">
                                            </td>
                                            <td>
                                                <label>{:L('FINISHTIME')}</label>
                                                <input style="width: 110px;" class="form-control" type="text" id="start_finishtime" name="start_finishtime" value="{$Think.get.start_finishtime}">
                                                <input style="width: 110px;" class="form-control" type="text" id="end_finishtime" name="end_finishtime" value="{$Think.get.end_finishtime}">
                                            </td>
                                            <td>
                                                <input type="submit" class="btn btn-primary" value="{:L('QUERY')}">
                                                <if condition="$filtered neq 0">
                                                    <a href="{:U('OrderTaskSjs/index')}" class="btn btn-default">{:L('BACKOUT')}</a>
                                                </if>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-center">
                                <thead>
                                <tr>
                                    <th>{:L('TASK_LIST_NAME')} </th>
                                    <th>{:L('TASK_ORDER')} </span></th>
                                      <th style="width: 100px"><span ectype="order_by" fieldname="t.isurgent">{:L('ISURGENT')}<i class="fa fa-sort"></i></span></th>
                                    <th style="width: 100px">{:L('TASK_STATE')}</th>
                                    <th style="width: 150px"><span ectype="order_by" fieldname="t.addtime">{:L('TASK_SEND_TIME')}<i class="fa fa-sort"></i></span></th>
                                    <th style="width: 150px"><span ectype="order_by" fieldname="t.finishtime">{:L('FINISHTIME')}<i class="fa fa-sort"></i></span></th>
                                    <th style="width: 80px">{:L('FINISHMAN')}</th>
                                    <th style="width: 120px">{:L('HANDLE')}</th>
                                </tr>
                                </thead>
                                <tbody>
                                <notempty name="lists">
                                    <volist name="lists" id="vo">
                                        <tr>
                                            <td style="text-align: left">{$vo['tname']}</td>
                                            <td>
                                                <a href="{:U('PlatOrder/view?id='.$vo['oid'])}">{$vo.order_sn}-{:L($vo['str_state'])}</a>
                                            </td>
                                            <td>
                                                <if condition="$vo['task_isurgent']">
                                                    <img src="__IMG__/prompt.png"/>
                                                    <else/>
                                                    <img src="__IMG__/positive_disabled.png"/>
                                                </if>
                                            </td>
                                            <td><if condition="$vo['task_state'] eq 1">{:L(FINISH)}<else/>{:L(NOFINISH)}</if></td>
                                            <td>
                                                <if condition="$vo['task_addtime']">{$vo['task_addtime']|date="Y-m-d H:i:s",###}<else/>-</if>
                                            </td>
                                            <td>
                                                <if condition="$vo['task_finishtime']">{$vo['task_finishtime']|date="Y-m-d H:i:s",###}<else/>-</if>
                                            </td>
                                            <td><if condition="$vo['task_finishuid'] gt 0">{$vo.task_finishman}<else/>-</if></td>
                                            <td>
                                                <if condition="($vo.task_state eq 0) && ($vo.canupplan eq 1)">
                                                    <a href="javascript:void(0);"  onclick="reply({$vo['tastkid']},{$vo['oid']},{$vo['vid']})"  data-width="800" data-height="600" class="btn btn-primary">{:L('FINISH_HANDEL')}</a>
                                                </if>
                                                <if condition="$vo.prompt eq 1"><span class="red">{:L('S_NOPAY')}</span></if>
                                            </td>
                                        </tr>
                                    </volist>
                                    <else />
                                    <tr>
                                        <td colspan="9">{:L('NOCONCENT')}</td>
                                    </tr>
                                </notempty>

                                </tbody>
                            </table>
                        </div>

                        <div class="modal fade" id="edit-form">

                            <div class="modal-dialog" >

                                <div class="modal-content">
                                    <div class="modal-header">
                                        <a class="close" href="#" data-dismiss="modal">×</a>
                                        <h3>{:L('S_TASK_TASK_SPEC')}</h3>
                                    </div>
                                    <div class="modal-body">

                                        <form action="{:U('OrderTaskSjs/confirm')}" class="form-horizontal" id="task_form" method='post' enctype="multipart/form-data">
                                            <input type="hidden" name="id" id="oid" value="" >
                                            <input type="hidden" name="task_id" id="task_id" value="" >
                                            <input type="hidden" name="vid" id="vid" value="" >

                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">{:L('S_TASK_SJS_UPLOAD')}</label>
                                                <div class="col-sm-10">
                                                    <div class="iviews-folder" id="drop-zone">
                                                        <div class="form-group-cbct-file iviews-folder-button">
                                                            {:L('S_TASK_SJS_UPLOAD')}
                                                            <input type="file" name="filesToUpload[]" id="filesToUpload" multiple="multiple" webkitdirectory="" directory=""/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">{:L('S_TASK_TASK_SPEC')}</label>
                                                <div class="col-sm-10">
                                                    <textarea  name="finishnote" id="finishnote" class="form-control" style="width: 400px;height: 170px;"></textarea>
                                                </div>
                                            </div>

                                        </form>

                                    </div>
                                    <div class="modal-footer">
                                        <a class="btn btn-default" data-dismiss="modal">{:L('S_TASK_CANCEL')}</a>
                                        <a href="javascript:void(0);"   id="save"  class="btn btn-primary" data-action="1">{:L('S_TASK_CONFIRM')}</a>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="iviews-order-mask" v-cloak v-if="step6.loadStatus">

                            <div class="iviews-order-load">
                                <span v-cloak :class="{ 'load': step6.flagStatus , 'success': !step6.flagStatus }">{{ step6.flagStatus ? '正在上传' : '上传结束' }}</span>
                                <a href="javascript:void(0);" class="iv-icon-close"></a>

                                <strong v-if="step6.flagStatus" v-cloak>正在上传: {{ step6.folder[0].file[step6.folder[0].file.length-1].name }}</strong>
                                <strong v-if="!step6.flagStatus">上传成功</strong>

                                <div class="folder-list">
                                    <div class="folder-size" v-cloak>大小: {{ step6.folder[0].file[step6.folder[0].file.length-1].size | sizeFilter }}</div>
                                    <div class="folder-progress" v-cloak>已上传:
                                        <small>{{ step6.folder[0].file.length }}</small>/{{ step6.folder[0].length }}</div>
                                </div>
                                <div class="tips">提示: 请勿关闭页面以免影响文件上传</div>

                            </div>
                        </div>


                        <div class="iviews-pager clearfix">
                            <div class="btn-group pull-right">
                                {$_page}
                            </div>
                        </div>

                    </div>
                </div>
                <!-- ibox end -->
            </div>
        </div>

    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        {:L('sysnotice')}
                    </h4>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">{:L('close')}</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>
    <!-- content end -->
    <script>
        $(document).ready(function(){
            var error_box = $("#errorModal");
            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });

            $("#save").click(function () {
                var id=$("#oid").val() ;
                var task_id=$("#task_id").val() ;
                var vid=$("#vid").val() ;
                var finishnote = $("#finishnote").val() ;
                $.ajax({
                    url: $('#task_form').attr('action') ,
                    type: 'POST' ,
                    data: {'id':id,'task_id':task_id,'finishnote':finishnote,'vid':vid},
                    dataType: 'json' ,
                    beforeSend: function() {
                    },
                    success: function(res) {
                        if( res.status == 1 ) {
                            window.location.href = res.url;
                        } else {
                            modal.text(error_box, res.info);
                            modal.open(error_box);
                        }
                    },
                    error: function(err) {
                    }

                })
            })

            $('body').on('click','.iviews-order-load > a',function(){
                $('body').removeClass('hasMask');
                $('#page-wrapper > .border-bottom').eq(0).removeClass('hasMask');
                $('#page-wrapper > .wrapper').eq(0).removeClass('hasMask');
                order.step6.loadStatus = false;
            })

            $('.cancle').click(function () {
                if(confirm("{:L('IF_CANCLE')}")) {
                    var tid = $(this).attr('key');
                    var url = $(this).attr('url');
                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: {'tid': tid},
                        dataType: 'json',
                        beforeSend: function () {
                        },
                        success: function (res) {
                            if (res.status == 1) {
                                window.location.href = res.url;
                            } else {
                                modal.text(error_box, res.info);
                                modal.open(error_box);
                            }
                        },
                        error: function (err) {
                        }

                    })
                }
            })
        });
        var vid = '';
        function reply($id,$oid,$vid) {
            $('.ui-select').chosen();
            $('#task_id').val($id);
            $('#oid').val($oid);
            $('#vid').val($vid);
            vid = $vid;
            modal.open('#edit-form');
        }
        $(function(){
        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        }
        var dropZone = document.getElementById('drop-zone');
        // var dropFile = document.getElementById('filesToUpload');
        dropZone.addEventListener('dragover', handleDragOver, false);

        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            var files = [], folder = '',
                items = evt.dataTransfer.items;

            order.step6.loadStatus = true;

            if ( order.step6.folder.length == 1 ) {
                // alert('CBCT只允许上传一个文件夹');
                order.step6.loadStatus = false;
               alert("{:L('CBCT_ONLY_ONE')}");
                return false;
            }

            function folderRead(entry,ordername) {
                var folderObj = { name: entry.name, total: 0, id: ordername, file: [] }

                entry.createReader().readEntries(function (entries) {
                    folderObj.length = entries.length;
                    // let total = 0;
                    for (var i = 0; i < entries.length; i++) {
                        var entrys = entries[i];

                        if (entrys.isFile) {
                            entrys.file(function (file) {

                                // total += file.size;
                                var fileObj = { name: file.name, size: file.size, type: file.type, time: 'ss'}
                                // order.step6.loadStatus = true;
                                // 打开状态层
                                var fd = new FormData();
                                fd.append('mypic', file);
                                var oid=   $('#oid').val();
                                var url = "{:U('Studio/OrderTaskSjs/fnUploadFile')}";
                                /* var path = files[x].webkitRelativePath.split('/');
                                 path.pop();
                                 var filename = path.toString().replace(/,/g,'/');*/

                                $.ajax({
                                    url: url+'&oid='+oid+'&vid='+vid,
                                    method: 'post',
                                    contentType: false, // 注意这里应设为false
                                    processData: false,
                                    cache: false,
                                    async: true,
                                    data: fd,
                                    success: function(res) {
                                        if ( typeof res == 'string' ) {
                                            res = JSON.parse(res);
                                        }

                                        if (!res) return false;
                                        fileObj.time = res.msg.addtime;
                                        fileObj.size = res.msg.size;
                                        fileObj.type = res.msg.ext;
                                        folderObj.total += res.msg.size;
                                        order.step6.flagStatus = true;
                                        folderObj.file.push(fileObj)
                                        // total +=res.size;
                                        if ( folderObj.length == folderObj.file.length ) {
                                            order.step6.flagStatus = false;
                                            // order.step6.loadStatus = false;
                                        }
                                        $.full.open();
                                    },
                                    error: function(error) {
                                        console.log(error);
                                    }
                                })
                                // folderObj.total =  format_bytes(total);
                                // folderObj.total = total;
                            })
                        } else {
                            folder = entrys.name;
                        }
                    }

                });
                order.step6.folder.push(folderObj)
            }
            for (var i = 0; i < items.length; i++) {
                var entry = items[i].webkitGetAsEntry();
                if (!entry) {
                    return;
                }
                if (entry.isFile) {
                    $.scojs_message("{:L('PFUPLOADFILE')}", $.scojs_message.TYPE_ERROR);
                } else {
                    folderRead(entry, '{$sn}');
                }
            }
        }
        dropZone.addEventListener('drop', handleFileSelect, false);


        $('#filesToUpload').on('change', function(ev, ordername){

            order.step6.loadStatus = true;

            if (order.step6.folder.length == 1) {
                order.step6.loadStatus = false;
                alert("{:L('CBCT_ONLY_ONE')}");
                return false;
            }

            ordername = '{$sn}'

            var folderObj = { name: '', id: ordername, total: 0, file: [], length: ev.target.files.length }

            if ( ev.target.files.length >= 1 ) {
                var files = ev.target.files;
                // var name = files[0].webkitRelativePath.split('/')[0];

                folderObj.name = name;

                for ( x in files ) {
                    if ( files[x].size ) {
                        let pathArr = files[x].webkitRelativePath.split('/');
                        pathArr.pop();
                        if ( files[x].size != 'undefined' && files[x].size >= 0 ) {
                            //total += files[x].size;
                            let fileObj = { path: pathArr.toString(), name: files[x].name, size: files[x].size, type: files[x].type, time: '' }
                            // var fileObj = { name: files[x].name, size: files[x].size, type: files[x].type, time: 'ss' }
                            var fd = new FormData();
                            fd.append('mypic', files[x]);
                            var oid=   $('#oid').val();
                            // fd.append('filename', 'ocdf/sdafsd');
                            var url1 = "{:U('Studio/OrderTaskSjs/fnUploadFile')}";
                            $.ajax({

                                url: url1+'&path='+pathArr.toString()+'&oid='+oid+'&vid='+vid,
                                method: 'post',
                                contentType: false, // 注意这里应设为false
                                processData: false,
                                cache: false,
                                async: true,
                                data: fd,
                                success: function (res) {
                                    // console.log(res);
                                    // console.log(res.size);
                                    if (typeof res == 'string') {
                                        res = JSON.parse(res);
                                    }
                                    var data = res;
                                    if (!data || data == 'false') return false;
                                    fileObj.time = data.msg.addtime;
                                    fileObj.size = data.msg.size;
                                    fileObj.type = data.msg.ext;
                                    order.step6.flagStatus = true;
                                    folderObj.file.push(fileObj)
                                    folderObj.total += data.msg.size;
                                    if (folderObj.length == folderObj.file.length) {
                                        order.step6.flagStatus = false;
                                        // order.step6.loadStatus = false;
                                    }

                                    $('.iviews-order-mask').css({
                                        'position': 'fixed',
                                        'width': $(window).width(),
                                        'height': $(window).height(),
                                        'left': -($('.navbar-default').width() + 15),
                                        'top': -$('#page-wrapper > .border-bottom').eq(0).height()
                                    })
                                    $('body').addClass('hasMask');
                                    $('#page-wrapper > .border-bottom').eq(0).addClass('hasMask');
                                    $('#page-wrapper > .wrapper').eq(0).addClass('hasMask');
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            })
                            // folderObj.total = format_bytes(total);
                        }
                    }
                }
                order.step6.folder.push(folderObj)

            } else {
                order.step6.loadStatus = false;
                alert('{:L("MISC")}');
            }

        })
        });

        var order = new Vue({
            el: '#app',
            data () {
                return {
                    step6: {
                        folder: [] ,
                        fileStatus: false,
                        flagStatus: false,
                        loadStatus: false,

                    },
                }
            },
            updated () {
                $('.full-height-scroll').slimscroll({
                    height: '480px'
                })

                if(order.step6.loadStatus || order.step6.fileStatus) {
                    $('.iviews-order-mask').css({
                        'position': 'fixed',
                        'width': $(window).width(),
                        'height': $(window).height(),
                        'left': -($('.navbar-default').width() + 15),
                        'top': -$('#page-wrapper > .border-bottom').eq(0).height()
                    })
                    $('body').addClass('hasMask');
                    $('#page-wrapper > .border-bottom').eq(0).addClass('hasMask');
                    $('#page-wrapper > .wrapper').eq(0).addClass('hasMask');

                    $.full.open();
                } else {
                    $('.iviews-order-mask').attr('style','');
                    $('body').removeClass('hasMask');
                    $('#page-wrapper > .border-bottom').eq(0).removeClass('hasMask');
                    $('#page-wrapper > .wrapper').eq(0).removeClass('hasMask');

                    $.full.close();
                }
            },
            filters: {
                sizeFilter (val) {
                    var $units =   ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                    for (var $i =0; val >= 1024 && $i < 5; $i++) val /= 1024;
                    return  val.toFixed(2) + $units[$i];
                },
            },
            methods: {
                step6FolderSee() {
                    this.step6.fileStatus = true;
                }
            }
        });

    </script>
</block>

